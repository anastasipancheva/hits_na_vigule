<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–æ—Å—Ç—É–ø–∞ - –°—á–∏—Ç—ã–≤–∞—Ç–µ–ª—å</title>
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <!-- –£–±—Ä–∞–ª–∏ –ø—Ä—è–º—É—é –∑–∞–≥—Ä—É–∑–∫—É qr-scanner.min.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        success: '#16a34a',
                        danger: '#dc2626',
                        warning: '#d97706'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–æ—Å—Ç—É–ø–∞</h1>
            <p class="text-gray-600">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ TOTP</p>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
        <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-6">
            <!-- –¢–∞–±—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–∞ -->
            <div class="flex border-b border-gray-200 mb-6">
                <button class="tab-button flex-1 py-2 px-4 text-center font-medium text-gray-600 hover:text-primary data-[active=true]:text-primary data-[active=true]:border-b-2 data-[active=true]:border-primary"
                        data-tab="manual" data-active="true">
                    üì± –ö–æ–¥ –≤—Ä—É—á–Ω—É—é
                </button>
                <button class="tab-button flex-1 py-2 px-4 text-center font-medium text-gray-600 hover:text-primary data-[active=true]:text-primary data-[active=true]:border-b-2 data-[active=true]:border-primary"
                        data-tab="qr">
                    üì∑ QR-–∫–æ–¥
                </button>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±–æ–≤ -->
            <div id="tab-content">
                <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ -->
                <div id="manual-tab" class="tab-content active">
                    <form id="manual-form" hx-post="/reader/verify-code" hx-target="#result-container" hx-trigger="submit" hx-indicator="#spinner">
                        <input type="hidden" name="method" value="manual">
                        <div class="space-y-4">
                            <label class="block text-sm font-medium text-gray-700">–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥:</label>
                            <input type="text" id="code-input" name="code" pattern="[0-9]{6}" maxlength="6" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-center text-2xl font-mono"
                                   placeholder="123456">
                            <button type="submit" class="w-full bg-primary text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø
                            </button>
                        </div>
                    </form>
                </div>

                <!-- QR-–∫–æ–¥ -->
                <div id="qr-tab" class="tab-content hidden">
                    <div class="space-y-4">
                        <label class="block text-sm font-medium text-gray-700">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥:</label>
                        <div class="relative">
                            <video id="qr-video" class="w-full h-64 bg-gray-200 rounded-lg"></video>
                            <div id="qr-overlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-lg">
                                <div class="text-white text-center">
                                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-2"></div>
                                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞...</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å QR-–∫–æ–¥–æ–º:</p>
                            <input type="file" id="qr-file" accept="image/*" class="hidden">
                            <button onclick="document.getElementById('qr-file').click()"
                                    class="bg-secondary text-white py-2 px-4 rounded-lg text-sm hover:bg-gray-600 transition-colors">
                                –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div id="spinner" class="htmx-indicator flex justify-center py-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
            <div id="result-container" class="mt-6"></div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã -->
        <div class="text-center mt-8">
            <div class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">
                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                –°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞
            </div>
        </div>
    </div>

    <script>
        class AccessReader {
            constructor() {
                this.qrScanner = null;
                this.QrScanner = null;
                this.init();
            }

            async init() {
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–∏—Ç—ã–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç—É–ø–∞...');
                this.setupTabs();
                this.setupFileUpload();
                this.setupAutoSubmit();
                this.setupFormPrevention();
            }

            setupFormPrevention() {
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
                const form = document.getElementById('manual-form');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ htmx
                        htmx.trigger(form, 'submit');
                    });
                }
            }

            setupAutoSubmit() {
                const codeInput = document.getElementById('code-input');
                if (!codeInput) return;

                codeInput.addEventListener('input', (e) => {
                    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
                    e.target.value = e.target.value.replace(/\D/g, '');

                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –≤–≤–æ–¥–µ 6 —Ü–∏—Ñ—Ä
                    if (e.target.value.length === 6) {
                        this.submitCode(e.target.value, 'manual');
                    }
                });
            }

            async loadQrScanner() {
                try {
                    // –ï—Å–ª–∏ QR Scanner —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                    if (typeof window.QrScanner !== 'undefined') {
                        this.QrScanner = window.QrScanner;
                        console.log('QR Scanner library already loaded.');
                        const overlay = document.getElementById('qr-overlay');
                        if (overlay) {
                            overlay.classList.add('hidden');
                        }
                        return;
                    }

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è
                    const { default: QrScanner } = await import('https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js?module');
                    this.QrScanner = QrScanner;
                    console.log('QR Scanner library loaded successfully.');

                    const overlay = document.getElementById('qr-overlay');
                    if (overlay) {
                        overlay.classList.add('hidden');
                    }

                } catch (error) {
                    console.error('Failed to load QR Scanner:', error);
                    this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å QR —Å–∫–∞–Ω–µ—Ä. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
                    const overlay = document.getElementById('qr-overlay');
                    if (overlay) {
                        overlay.innerHTML = `
                            <div class="text-white text-center">
                                <div class="text-2xl mb-2">‚ùå</div>
                                <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞</p>
                                <p class="text-sm mt-1">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤</p>
                            </div>
                        `;
                    }
                }
            }

            setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                tabButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tabName = e.currentTarget.dataset.tab;
                        this.switchTab(tabName);
                    });
                });
            }

            async switchTab(tabName) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                document.querySelectorAll('.tab-button').forEach(btn => {
                    const isActive = btn.dataset.tab === tabName;
                    btn.setAttribute('data-active', isActive);
                });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
                document.querySelectorAll('.tab-content').forEach(content => {
                    const isActive = content.id === `${tabName}-tab`;
                    content.classList.toggle('hidden', !isActive);
                    content.classList.toggle('active', isActive);
                });

                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
                this.stopQRScanner();

                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∞–±–∞
                if (tabName === 'qr') {
                    await this.loadQrScanner();
                    await this.startQRScanner();
                }
            }

            async startQRScanner() {
                try {
                    const video = document.getElementById('qr-video');
                    const overlay = document.getElementById('qr-overlay');

                    if (!video || !this.QrScanner) {
                        this.showError('QR —Å–∫–∞–Ω–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                        return;
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    if (overlay) {
                        overlay.classList.remove('hidden');
                        overlay.innerHTML = `
                            <div class="text-white text-center">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-2"></div>
                                <p>–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...</p>
                            </div>
                        `;
                    }

                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º QR —Å–∫–∞–Ω–µ—Ä
                    this.qrScanner = new this.QrScanner(
                        video,
                        result => this.handleQRResult(result),
                        {
                            onDecodeError: (error) => {
                                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ–±—ã—á–Ω—ã–µ –æ—à–∏–±–∫–∏ "QR code not found"
                                if (!error.includes('No QR code found')) {
                                    console.log('QR scanning error:', error);
                                }
                            },
                            highlightScanRegion: true,
                            highlightCodeOutline: true,
                        }
                    );

                    await this.qrScanner.start();
                    console.log('QR —Å–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω');

                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    if (overlay) {
                        overlay.classList.add('hidden');
                    }

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ QR —Å–∫–∞–Ω–µ—Ä–∞:', error);

                    const overlay = document.getElementById('qr-overlay');
                    if (overlay) {
                        overlay.innerHTML = `
                            <div class="text-white text-center">
                                <div class="text-2xl mb-2">‚ùå</div>
                                <p>–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ</p>
                                <p class="text-sm mt-1">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª—ã</p>
                            </div>
                        `;
                    }

                    this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
                }
            }

            stopQRScanner() {
                if (this.qrScanner) {
                    this.qrScanner.stop();
                    this.qrScanner.destroy();
                    this.qrScanner = null;
                    console.log('QR —Å–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                }
            }

            handleQRResult(result) {
                console.log('QR –∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω:', result);

                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏–∑ QR –∫–æ–¥–∞
                const digits = result.data.replace(/\D/g, '');

                if (digits.length === 6) {
                    this.submitCode(digits, 'qr');
                    // –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                } else {
                    this.showError(`QR –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ 6 —Ü–∏—Ñ—Ä: ${digits}`);
                    // –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –ø—Ä–∏ –æ—à–∏–±–∫–µ
                }
            }

            setupFileUpload() {
                const fileInput = document.getElementById('qr-file');
                if (!fileInput) return;

                fileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        this.scanQRFromFile(file);
                    }
                });
            }

            async scanQRFromFile(file) {
                try {
                    const overlay = document.getElementById('qr-overlay');
                    if (overlay) {
                        overlay.classList.remove('hidden');
                        overlay.innerHTML = `
                            <div class="text-white text-center">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-2"></div>
                                <p>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...</p>
                            </div>
                        `;
                    }

                    if (!this.QrScanner) {
                        await this.loadQrScanner();
                    }

                    // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è —Ñ–∞–π–ª–∞
                    const imageUrl = URL.createObjectURL(file);

                    // –°–∫–∞–Ω–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    const result = await this.QrScanner.scanImage(imageUrl);

                    URL.revokeObjectURL(imageUrl); // –û—á–∏—â–∞–µ–º URL

                    if (overlay) {
                        overlay.classList.add('hidden');
                    }

                    if (result) {
                        this.handleQRResult({ data: result });
                    } else {
                        this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å QR –∫–æ–¥ –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏');
                    }

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞:', error);

                    const overlay = document.getElementById('qr-overlay');
                    if (overlay) {
                        overlay.classList.add('hidden');
                    }

                    this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å QR –∫–æ–¥: ' + error.message);
                }
            }

            submitCode(code, method) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const spinner = document.getElementById('spinner');
                if (spinner) {
                    spinner.classList.remove('htmx-indicator');
                }

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º htmx –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                htmx.ajax('POST', '/reader/verify-code', {
                    values: {
                        code: code,
                        method: method
                    },
                    target: '#result-container',
                    swap: 'innerHTML',
                    onSuccess: () => {
                        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
                        if (method === 'manual') {
                            const codeInput = document.getElementById('code-input');
                            if (codeInput) {
                                codeInput.value = '';
                            }
                        }

                        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        if (spinner) {
                            spinner.classList.add('htmx-indicator');
                        }
                    },
                    onError: () => {
                        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                        if (spinner) {
                            spinner.classList.add('htmx-indicator');
                        }
                    }
                });
            }

            showError(message) {
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                const errorDiv = document.createElement('div');
                errorDiv.className = 'p-3 mb-4 bg-red-100 border border-red-400 text-red-700 rounded';
                errorDiv.textContent = message;

                const container = document.getElementById('result-container');
                if (container) {
                    container.prepend(errorDiv);
                    // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => {
                        if (errorDiv.parentNode) {
                            errorDiv.parentNode.removeChild(errorDiv);
                        }
                    }, 5000);
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            window.accessReader = new AccessReader();
        });
    </script>
</body>
</html>